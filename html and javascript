<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<form id="form-liquidation">
    <div id="main-content-container" class="main-content">
        <div class="tblb">
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-title"><strong>Liquidation Calculator</strong></div>
            </div>
        </div>
        <div class="tblb">
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description">Case Number:</div>
                <div class="tblb-cell"><input id="input-11" type="text" name="CaseNumber" autofocus="" tabindex="11" aria-label="Case Number"></div>
                <div class="tblb-cell"></div>
                <div class="tblb-cell"></div>
                <div class="tblb-cell"></div>
                <div class="tblb-cell"></div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description">Type of Asset:</div>
                <div class="tblb-cell"><input id="input-21" type="text" name="AssetDescription" tabindex="12" aria-label="Asset Description"></div>
                <div class="tblb-cell"><input id="input-22" type="text" name="AssetDescription" tabindex="19" aria-label="Asset Description"></div>
                <div class="tblb-cell"><input id="input-23" type="text" name="AssetDescription" tabindex="26" aria-label="Asset Description"></div>
                <div class="tblb-cell"><input id="input-24" type="text" name="AssetDescription" tabindex="33" aria-label="Asset Description"></div>
                <div class="tblb-cell"><input id="input-25" type="text" name="AssetDescription" tabindex="40" aria-label="Asset Description"></div>
                <div class="tblb-cell"><strong>TOTALS</strong></div>
            </div>
        </div>
        <div class="tblb">
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-head"><strong>Determination of Non-Exempt Equity</strong></div>
            </div>
        </div>
        <div class="tblb">
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description">Full Fair Market Value of Asset:</div>
                <div class="tblb-cell"><input id="input-31" class="money-format" type="text" name="AssetValue" tabindex="13" aria-label="Value of Asset"></div>
                <div class="tblb-cell"><input id="input-32" class="money-format" type="text" name="AssetValue" tabindex="20" aria-label="Value of Asset"></div>
                <div class="tblb-cell"><input id="input-33" class="money-format" type="text" name="AssetValue" tabindex="27" aria-label="Value of Asset"></div>
                <div class="tblb-cell"><input id="input-34" class="money-format" type="text" name="AssetValue" tabindex="34" aria-label="Value of Asset"></div>
                <div class="tblb-cell"><input id="input-35" class="money-format" type="text" name="AssetValue" tabindex="41" aria-label="Value of Asset"></div>
                <div class="tblb-cell tblb-cell-total-bold" id="total-36">$0.00</div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description">Liens:</div>
                <div class="tblb-cell"><input id="input-41" class="money-format" type="text" name="Liens" tabindex="14" aria-label="Amount of Liens"></div>
                <div class="tblb-cell"><input id="input-42" class="money-format" type="text" name="Liens" tabindex="21" aria-label="Amount of Liens"></div>
                <div class="tblb-cell"><input id="input-43" class="money-format" type="text" name="Liens" tabindex="28" aria-label="Amount of Liens"></div>
                <div class="tblb-cell"><input id="input-44" class="money-format" type="text" name="Liens" tabindex="35" aria-label="Amount of Liens"></div>
                <div class="tblb-cell"><input id="input-45" class="money-format" type="text" name="Liens" tabindex="42" aria-label="Amount of Liens"></div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description"><strong>Debtor's Equity:</strong></div>
                <div id="total-51" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-52" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-53" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-54" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-55" class="tblb-cell tblb-cell-total">$0.00</div>
                <div class="tblb-cell tblb-cell-total-bold" id="total-56">$0.00</div>
            </div>
        </div>
        <div class="tblb">
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-head"><strong>Determination of Exemptions</strong></div>
            </div>
        </div>
        <div class="tblb">
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description">Type of Exemption:</div>
                <div class="tblb-cell"><input id="input-61" type="text" name="ExemptionDescription" tabindex="15" aria-label="Exemption Description"></div>
                <div class="tblb-cell"><input id="input-62" type="text" name="ExemptionDescription" tabindex="22" aria-label="Exemption Description"></div>
                <div class="tblb-cell"><input id="input-63" type="text" name="ExemptionDescription" tabindex="29" aria-label="Exemption Description"></div>
                <div class="tblb-cell"><input id="input-64" type="text" name="ExemptionDescription" tabindex="36" aria-label="Exemption Description"></div>
                <div class="tblb-cell"><input id="input-65" type="text" name="ExemptionDescription" tabindex="43" aria-label="Exemption Description"></div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description">Amount of Exemption:</div>
                <div class="tblb-cell"><input id="input-71" class="money-format" type="text" name="ExemptionAmount" tabindex="16" aria-label="Amount of Exemption"></div>
                <div class="tblb-cell"><input id="input-72" class="money-format" type="text" name="ExemptionAmount" tabindex="23" aria-label="Amount of Exemption"></div>
                <div class="tblb-cell"><input id="input-73" class="money-format" type="text" name="ExemptionAmount" tabindex="30" aria-label="Amount of Exemption"></div>
                <div class="tblb-cell"><input id="input-74" class="money-format" type="text" name="ExemptionAmount" tabindex="37" aria-label="Amount of Exemption"></div>
                <div class="tblb-cell"><input id="input-75" class="money-format" type="text" name="ExemptionAmount" tabindex="44" aria-label="Amount of Exemption"></div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description">Wildcard Exemption Used:</div>
                <div class="tblb-cell"><input id="input-81" class="money-format" type="text" name="WildcardAmount" tabindex="17" aria-label="Wildcard Exemption"></div>
                <div class="tblb-cell"><input id="input-82" class="money-format" type="text" name="WildcardAmount" tabindex="24" aria-label="Wildcard Exemption"></div>
                <div class="tblb-cell"><input id="input-83" class="money-format" type="text" name="WildcardAmount" tabindex="31" aria-label="Wildcard Exemption"></div>
                <div class="tblb-cell"><input id="input-84" class="money-format" type="text" name="WildcardAmount" tabindex="38" aria-label="Wildcard Exemption"></div>
                <div class="tblb-cell"><input id="input-85" class="money-format" type="text" name="WildcardAmount" tabindex="45" aria-label="Wildcard Exemption"></div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description"><strong>Total Exemptions Used:</strong></div>
                <div id="total-91" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-92" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-93" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-94" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-95" class="tblb-cell tblb-cell-total">$0.00</div>
                <div class="tblb-cell"></div>
            </div>
        </div>
        <div class="tblb">
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-head"><strong>Hypothetical Administrative Costs of Chapter 7 Trustee</strong></div>
            </div>
        </div>
        <div class="tblb">
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description">Disbursement Amount:<br><span class="span-fees-description">Value of asset minus exemptions</span></div>
                <div id="total-101" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-102" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-103" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-104" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-105" class="tblb-cell tblb-cell-total">$0.00</div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description">First $5,000:<br><span class="span-fees-description">25% of Disbursement</span></div>
                <div id="total-111" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-112" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-113" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-114" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-115" class="tblb-cell tblb-cell-total">$0.00</div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description">Between $5,000 &amp; $50,000:<br><span class="span-fees-description">10% of Disbursement</span></div>
                <div id="total-121" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-122" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-123" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-124" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-125" class="tblb-cell tblb-cell-total">$0.00</div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description">Between $50,000 &amp; $1,000,000:<br><span class="span-fees-description">5% of Disbursement</span></div>
                <div id="total-131" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-132" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-133" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-134" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-135" class="tblb-cell tblb-cell-total">$0.00</div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description">Greater Than $1,000,000:<br><span class="span-fees-description">3% of Disbursement</span></div>
                <div id="total-141" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-142" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-143" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-144" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-145" class="tblb-cell tblb-cell-total">$0.00</div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description"><strong>Total Hypothetical Chapter 7 Trustee Fees:</strong></div>
                <div id="total-151" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-152" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-153" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-154" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-155" class="tblb-cell tblb-cell-total">$0.00</div>
                <div class="tblb-cell tblb-cell-total-bold" id="total-156">$0.00</div>
            </div>
        </div>
        <div class="tblb">
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-head"><strong>Final Determination of Values</strong></div>
            </div>
        </div>
        <div class="tblb">
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description"><strong>Full Fair Market Value of Asset:</strong></div>
                <div id="total-161" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-162" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-163" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-164" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-165" class="tblb-cell tblb-cell-total">$0.00</div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description tblb-cell-indent">Percentage Cost of Sale:</div>
                <div class="tblb-cell">
                    <select id="select-171" class="select-percentage-cos" name="PercentageCOS" aria-label="Percentage Cost of Sale">
                        <optgroup label="Property">
                            <option value="0.09">9.00%</option>
                        </optgroup>
                        <optgroup label="Cash Asset">
                            <option value="0">0.00%</option>
                        </optgroup>
                    </select>
                </div>
                <div class="tblb-cell">
                    <select id="select-172" class="select-percentage-cos" name="PercentageCOS" aria-label="Percentage Cost of Sale">
                        <optgroup label="Property">
                            <option value="0.09">9.00%</option>
                        </optgroup>
                        <optgroup label="Cash Asset">
                            <option value="0">0.00%</option>
                        </optgroup>
                    </select>
                </div>
                <div class="tblb-cell">
                    <select id="select-173" class="select-percentage-cos" name="PercentageCOS" aria-label="Percentage Cost of Sale">
                        <optgroup label="Property">
                            <option value="0.09">9.00%</option>
                        </optgroup>
                        <optgroup label="Cash Asset">
                            <option value="0">0.00%</option>
                        </optgroup>
                    </select>
                </div>
                <div class="tblb-cell">
                    <select id="select-174" class="select-percentage-cos" name="PercentageCOS" aria-label="Percentage Cost of Sale">
                        <optgroup label="Property">
                            <option value="0.09">9.00%</option>
                        </optgroup>
                        <optgroup label="Cash Asset">
                            <option value="0">0.00%</option>
                        </optgroup>
                    </select>
                </div>
                <div class="tblb-cell">
                    <select id="select-175" class="select-percentage-cos" name="PercentageCOS" aria-label="Percentage Cost of Sale">
                        <optgroup label="Property">
                            <option value="0.09">9.00%</option>
                        </optgroup>
                        <optgroup label="Cash Asset">
                            <option value="0">0.00%</option>
                        </optgroup>
                    </select>
                </div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description tblb-cell-indent">Hypothetical Cost of Sale:</div>
                <div id="total-181" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-182" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-183" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-184" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-185" class="tblb-cell tblb-cell-total">$0.00</div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description tblb-cell-indent">Chapter 7 Trustee Fees:</div>
                <div id="total-191" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-192" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-193" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-194" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-195" class="tblb-cell tblb-cell-total">$0.00</div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description"><strong>Subtotal:</strong></div>
                <div id="total-201" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-202" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-203" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-204" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-205" class="tblb-cell tblb-cell-total">$0.00</div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description tblb-cell-indent">Liens:</div>
                <div id="total-211" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-212" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-213" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-214" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-215" class="tblb-cell tblb-cell-total">$0.00</div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description"><strong>Net Equity:</strong></div>
                <div id="total-221" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-222" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-223" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-224" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-225" class="tblb-cell tblb-cell-total">$0.00</div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description tblb-cell-indent">Percentage of Ownership:</div>
                <div class="tblb-cell"><input id="input-231" class="percent-format" type="text" name="PercentageOwnership" value="100.00%" tabindex="18"></div>
                <div class="tblb-cell"><input id="input-232" class="percent-format" type="text" name="PercentageOwnership" value="100.00%" tabindex="25"></div>
                <div class="tblb-cell"><input id="input-233" class="percent-format" type="text" name="PercentageOwnership" value="100.00%" tabindex="32"></div>
                <div class="tblb-cell"><input id="input-234" class="percent-format" type="text" name="PercentageOwnership" value="100.00%" tabindex="39"></div>
                <div class="tblb-cell"><input id="input-235" class="percent-format" type="text" name="PercentageOwnership" value="100.00%" tabindex="46"></div>
                <div class="tblb-cell"></div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description"><strong>Total Equity:</strong></div>
                <div id="total-241" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-242" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-243" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-244" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-245" class="tblb-cell tblb-cell-total">$0.00</div>
                <div class="tblb-cell tblb-cell-total-bold" id="total-246">$0.00</div>
            </div>
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description"><strong>Total Exemptions Used:</strong></div>
                <div id="total-251" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-252" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-253" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-254" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-255" class="tblb-cell tblb-cell-total">$0.00</div>
                <div id="total-256" class="tblb-cell tblb-cell-total-bold">$0.00</div>
            </div>
        </div>
        <div class="tblb">
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-head"><strong>Minimum Distribution to Priority and General Unsecured Claims to Protect Non-Exempt Equity</strong></div>
            </div>
        </div>
        <div class="tblb">
            <div class="tblb-row">
                <div class="tblb-cell tblb-cell-description">Minimum Distribution to all Unsecured Claims:</div>
                <div class="tblb-cell"></div>
                <div class="tblb-cell"></div>
                <div class="tblb-cell"></div>
                <div class="tblb-cell"></div>
                <div class="tblb-cell"></div>
                <div id="total-266" class="tblb-cell tblb-cell-total-bold">$0.00</div>
            </div>
        </div>
    </div>
    <div class="button-content">
        <button id="btn-reset" class="button-reset" type="button" onclick="calcReset">Reset</button>
        <button id="btn-pdf" class="button-pdf" type="button" onclick="calcPDF">Save PDF</button>
    </div>
</form>

<!-- Initialize Objects -->
<script>
const CURRENCY_FORMAT = { style: "currency", currency: "USD" };
const TIER_LIMITS = [5000, 50000, 1000000];
const TIER_PERCENTAGES = [0.25, 0.10, 0.05, 0.03];
const FEES = [1250, 5750, 53250];
</script>

<script>
// Function to create liquidationObjects
const createAsset = () => ({
    fairMarketValue: 0,
    percentageOwnership: 100,
    liens: 0,
    exemption: 0,
    wildcardExemption: 0,
    chapter7Fees: 0,
    percentageCOS: 0.09,
    get equity() {
        return this.fairMarketValue - this.liens;
    },
    get costOfSale() {
        return this.fairMarketValue * this.percentageCOS;
    }
});

// Create liquidationObjects
const liquidationObject = {
    asset: {
        '1': createAsset(),
        '2': createAsset(),
        '3': createAsset(),
        '4': createAsset(),
        '5': createAsset()
    }
};
</script>

<script>
// Reset the liquidation object values
function resetLiquidationValues() {
    const len = Object.keys(liquidationObject.asset).length;
    const excludedProps = new Set(['equity', 'costOfSale']);

    for (let i = 1; i <= len; i++) {
        for (let prop in liquidationObject.asset[i]) {
            if (!excludedProps.has(prop)) {
                if (prop == 'percentageOwnership') {
                    liquidationObject.asset[i][prop] = 100;
                } else if (prop == 'percentageCOS') {
                    liquidationObject.asset[i][prop] = 0.09;
                } else {
                    liquidationObject.asset[i][prop] = 0;
                }
            }
        }
    }
}
</script>

<!-- Initialize Form -->
<script>
// const formInit = () => {
//     document.getElementById('btn-reset').addEventListener('click', calcReset);
//     document.getElementById('btn-pdf').addEventListener('click', calcPDF);
// };

const calcReset = (event) => {
    document.getElementById('form-liquidation').reset();
    resetLiquidationValues();
    calcAll();
    window.scrollTo({top: 0,left: 0,behavior: 'smooth'});
};

const calcPDF = (event) => {
    generatePDF();
};

// initialize the form once the page has loaded
document.addEventListener('DOMContentLoaded',formInit);

// ignore enter keypress event
document.addEventListener('keydown', (event) => {
    if (event.key === 'Enter') {
        event.preventDefault();
    }
});

</script>

<!-- Format Inputs -->
<script>
const money = document.querySelectorAll(".money-format");
money.forEach(function(input) {
    input.addEventListener("change", () => {
        moneyFormat(input);
    }); 
});

const percent = document.querySelectorAll(".percent-format");
percent.forEach(function(input) {
    input.addEventListener("change", () => {
        percentFormat(input);
    }); 
});

// Replace negative numbers with zero. Replace non-numeric values with blank.
function moneyFormat(inputValue) {
    const min = 0;
    const num = parseFloat(inputValue.value.replace(/[%,]+/g, ""));
    if (!isNaN(parseFloat(num))) {
        if (num < min) {
            inputValue.value = min.toLocaleString("en-US", CURRENCY_FORMAT);
        }else {
            inputValue.value = num.toLocaleString("en-US", CURRENCY_FORMAT);
        }
    }else {
        inputValue.value = "";
    }
};

// Maximum percent allowed is 100. Replace non-numeric values with blank.
function percentFormat(inputValue) {
    const min = 0;
    const max = 100;
    let num = parseFloat(inputValue.value.replace(/[%,]+/g, ""));
    num = Math.min(Math.max(num, min), max); // Clamps value between min (0) and max (100)
    if(!isNaN(num)){
        inputValue.value = num.toFixed(2) + "%";
    }else{
        inputValue.value = parseFloat(max).toFixed(2) + "%";
    }
}

// remove formating from inputs when performing calculations.
function removeFormat(inputValue){
    return Number(inputValue.replace(/[^0-9.-]+/g, ""));
};
</script>

<!-- Update liquidationObject values-->
<script>
// Update liquidationObject when input values change.
const fairMarketInput = document.querySelectorAll("#input-31,#input-32,#input-33,#input-34,#input-35");
fairMarketInput.forEach(function(input) {
    input.addEventListener("change", function() {
        const id = this.id;
        const asset = id.charAt(id.length - 1);
        const val = this.value;
        liquidationObject.asset[asset].fairMarketValue = parseFloat(removeFormat(val));
        calcAll();
    });
});

// Update liquidationObject when input values change.
const percentageCOSInput = document.querySelectorAll("#select-171,#select-172,#select-173,#select-174,#select-175");
percentageCOSInput.forEach(function(input) {
    input.addEventListener("change", function() {
        const id = this.id;
        const asset = id.charAt(id.length - 1);
        const val = this.value;
        liquidationObject.asset[asset].percentageCOS = parseFloat(removeFormat(val));
        calcAll();
    });
});

// Update liquidationObject when input values change.
const percentageOwnInput = document.querySelectorAll("#input-231,#input-232,#input-233,#input-234,#input-235");
percentageOwnInput.forEach(function(input) {
    input.addEventListener("change", function() {
        const id = this.id;
        const asset = id.charAt(id.length - 1);
        const val = this.value;
        liquidationObject.asset[asset].percentageOwnership = parseFloat(removeFormat(val));
        calcAll();
    });
});

// Update liquidationObject when input values change.
const liensInput = document.querySelectorAll("#input-41,#input-42,#input-43,#input-44,#input-45");
liensInput.forEach(function(input) {
    input.addEventListener("change", function() {
        const id = this.id;
        const asset = id.charAt(id.length -1 );
        const val = this.value;
        liquidationObject.asset[asset].liens = parseFloat(removeFormat(val));
        calcAll();
    });
});

// Update liquidationObject when input values change. Don't store exemption amount when zero or negative eqity exists.
const exemptionInput = document.querySelectorAll("#input-71,#input-72,#input-73,#input-74,#input-75");
exemptionInput.forEach(function(input) {
    input.addEventListener("change", function(){
        const id = this.id;
        const asset = id.charAt(id.length - 1);
        const val = this.value;
        if(liquidationObject.asset[asset].equity >= 0){
            liquidationObject.asset[asset].exemption = parseFloat(removeFormat(val));
        }
        calcAll();
    });
});

// Update liquidationObject when input values change. Don't store exemption amount when zero or negative eqity exists.
const wildcardInput = document.querySelectorAll("#input-81,#input-82,#input-83,#input-84,#input-85");
wildcardInput.forEach(function(input) {
    input.addEventListener("change", function(){
        const id = this.id;
        const asset = id.charAt(id.length - 1);
        const val = this.value;
        if(liquidationObject.asset[asset].equity >= 0){
            liquidationObject.asset[asset].wildcardExemption = parseFloat(removeFormat(val));
        }
        calcAll();
    });
});
</script>

<!-- Calculate Values -->
<script>
// Total fair market value
function fairMarketSum() {
    const { asset } = liquidationObject;
    const sum = Object.values(asset).reduce(getSum, 0);
    function getSum(total, asset) {
        return total + asset.fairMarketValue;
    }
    document.getElementById("total-36").innerHTML = sum.toLocaleString("en-US", CURRENCY_FORMAT);
};

// Individual item fair market value 
function debtorFMV(){
    const { asset } = liquidationObject;
    const len = Object.keys(asset).length;
    for (let i = 1; i <= len; i++) {
        document.getElementById("total-16" + i).innerHTML = asset[i].fairMarketValue.toLocaleString("en-US", CURRENCY_FORMAT);
    }
}

// Individual item liens
function liens(){
    const { asset } = liquidationObject;
    const len = Object.keys(asset).length;
    for (let i = 1; i <= len; i++) {
        document.getElementById("total-21" + i).innerHTML = asset[i].liens.toLocaleString("en-US", CURRENCY_FORMAT);
    }
}

// Individual and total debtor equity 
function debtorEquity(){
    const { asset } = liquidationObject;
    const len = Object.keys(asset).length;
    const sum = Object.values(asset).reduce(getSum, 0);

    function getSum(total, asset) {
        return total + Math.max(0,asset.equity); // Ignore negative equity in equityTotal calculation. 
    }

    // Change background when negative equity is calculated
    for (let i = 1; i <= len; i++) {
        const total = document.getElementById("total-5" + i);
        asset[i].equity < 0 ? total.classList.replace("tblb-cell-total", "tblb-cell-total-negative") : total.classList.replace("tblb-cell-total-negative", "tblb-cell-total");
        total.innerHTML = asset[i].equity.toLocaleString("en-US", CURRENCY_FORMAT);
    }

    // Update total equity
    document.getElementById("total-56").innerHTML = sum.toLocaleString("en-US", CURRENCY_FORMAT);
}

// Total exemptions
function exemptionsSum() {
    const { asset } = liquidationObject;
    const len = Object.keys(asset).length;

    for (let i = 1; i <= len; i++) {
        const exemptionInput = document.getElementById("input-7" + i);
        const wildcardInput = document.getElementById("input-8" + i);

        // Update liquidationObject when function called, in addition to the input change event. 
        asset[i].exemption = parseFloat(removeFormat(exemptionInput.value));
        asset[i].wildcardExemption = parseFloat(removeFormat(wildcardInput.value));

        const equity = Math.max(0, asset[i].equity);
        const exemptionSum = Math.min(equity, (asset[i].exemption + asset[i].wildcardExemption));

        document.getElementById("total-9" + i).innerHTML = exemptionSum.toLocaleString("en-US", CURRENCY_FORMAT);
    };
};

// Chapter 7 fee calculation
function chapter7Fees() {
    const { asset } = liquidationObject;
    const len = Object.keys(asset).length;
    let feesTotal = 0;

    for (let i = 1; i <= len; i++) {
        const equity = Math.max(0, asset[i].equity); // Ignore negatvie equity when calculating fees. 
        const liens = asset[i].liens;
        const exemptions = Math.min(equity, (asset[i].exemption + asset[i].wildcardExemption)); //Ignore exemptions greater than equity. 
        const disbursementAmount = equity + liens - exemptions;
        let feesSubTotal = 0;

        // Clear all totals before recalculating. 
        // total-101, total-111, total-121,
        // total-102, total-112, total-122, etc.
        for (let j = 10; j <= 15; j++) {
            document.getElementById("total-" + j + i).innerHTML = '$0.00';
        }

        if (equity - exemptions == 0) {
            document.getElementById("total-10" + i).innerHTML = '$0.00';
            asset[i].chapter7Fees = feesSubTotal;
        } 
        
        // Calculate fee for the first tier (0 to 5000)
        else if (disbursementAmount < TIER_LIMITS[0]) {
            document.getElementById("total-10" + i).innerHTML = disbursementAmount.toLocaleString("en-US", CURRENCY_FORMAT);
            document.getElementById("total-11" + i).innerHTML = (disbursementAmount * TIER_PERCENTAGES[0]).toLocaleString("en-US", CURRENCY_FORMAT);
            feesSubTotal = (disbursementAmount * TIER_PERCENTAGES[0]);
            feesTotal += feesSubTotal;
            asset[i].chapter7Fees = feesSubTotal;
        } 
        
        // Calculate fee for the second tier (5000 to 50000)
        else if (disbursementAmount >= TIER_LIMITS[0] && disbursementAmount < TIER_LIMITS[1]) {
            document.getElementById("total-10" + i).innerHTML = disbursementAmount.toLocaleString("en-US", CURRENCY_FORMAT);
            document.getElementById("total-11" + i).innerHTML = (TIER_PERCENTAGES[0] * TIER_LIMITS[0]).toLocaleString("en-US", CURRENCY_FORMAT);
            document.getElementById("total-12" + i).innerHTML = (TIER_PERCENTAGES[1] * (disbursementAmount - TIER_LIMITS[0])).toLocaleString("en-US", CURRENCY_FORMAT);
            feesSubTotal = parseFloat((TIER_PERCENTAGES[1] * (disbursementAmount - TIER_LIMITS[0])) + FEES[0]);
            feesTotal += feesSubTotal;
            asset[i].chapter7Fees = feesSubTotal;
        } 
        
        // Calculate fee for the third tier (50000 to 1000000)
        else if (disbursementAmount >= TIER_LIMITS[1] && disbursementAmount < TIER_LIMITS[2]) {
            document.getElementById("total-10" + i).innerHTML = disbursementAmount.toLocaleString("en-US", CURRENCY_FORMAT);
            document.getElementById("total-11" + i).innerHTML = (TIER_PERCENTAGES[0] * TIER_LIMITS[0]).toLocaleString("en-US", CURRENCY_FORMAT);
            document.getElementById("total-12" + i).innerHTML = (TIER_PERCENTAGES[1] * (TIER_LIMITS[1] - TIER_LIMITS[0])).toLocaleString("en-US", CURRENCY_FORMAT);
            document.getElementById("total-13" + i).innerHTML = (TIER_PERCENTAGES[2] * (disbursementAmount - TIER_LIMITS[1])).toLocaleString("en-US", CURRENCY_FORMAT);
            feesSubTotal = parseFloat((TIER_PERCENTAGES[2] * (disbursementAmount - TIER_LIMITS[1])) + FEES[1]);
            feesTotal += feesSubTotal;
            asset[i].chapter7Fees = feesSubTotal;
        } 
        
        // Calculate fee for the fourth tier (above 1000000)
        else if (disbursementAmount >= TIER_LIMITS[2]) {
            document.getElementById("total-10" + i).innerHTML = disbursementAmount.toLocaleString("en-US", CURRENCY_FORMAT);
            document.getElementById("total-11" + i).innerHTML = (TIER_PERCENTAGES[0] * TIER_LIMITS[0]).toLocaleString("en-US", CURRENCY_FORMAT);
            document.getElementById("total-12" + i).innerHTML = (TIER_PERCENTAGES[1] * (TIER_LIMITS[1] - TIER_LIMITS[0])).toLocaleString("en-US", CURRENCY_FORMAT);   
            document.getElementById("total-13" + i).innerHTML = (TIER_PERCENTAGES[2] * (TIER_LIMITS[2] - TIER_LIMITS[1])).toLocaleString("en-US", CURRENCY_FORMAT);
            document.getElementById("total-14" + i).innerHTML = (TIER_PERCENTAGES[3] * (disbursementAmount - TIER_LIMITS[2])).toLocaleString("en-US", CURRENCY_FORMAT);
            feesSubTotal = parseFloat((TIER_PERCENTAGES[3] * (disbursementAmount - TIER_LIMITS[2])) + FEES[2]);
            feesTotal += feesSubTotal;
            asset[i].chapter7Fees = feesSubTotal;
        }
        document.getElementById("total-15" + i).innerHTML = feesSubTotal.toLocaleString("en-US", CURRENCY_FORMAT);
        document.getElementById("total-19" + i).innerHTML = feesSubTotal.toLocaleString("en-US", CURRENCY_FORMAT);
        document.getElementById("total-156").innerHTML = feesTotal.toLocaleString("en-US", CURRENCY_FORMAT);
    }
};

function costOfSale() {
    const { asset } = liquidationObject;
    const len = Object.keys(asset).length;
    let exemptionTotal = 0;
    let debtorEquityTotal = 0;
    let distributionUnsecureds = 0;

    for (let i = 1; i <= len; i++) {
        const cos = asset[i].costOfSale;
        const cosSubTotal = asset[i].fairMarketValue - liquidationObject.asset[i].costOfSale - liquidationObject.asset[i].chapter7Fees;
        const netEquity = Math.max(0, cosSubTotal - asset[i].liens); // ignore negative net equity.  
        const debtorEquity = Math.max(0, parseFloat((cosSubTotal - asset[i].liens) * asset[i].percentageOwnership /100)); // ignore negative net equity.  
        const exemptions = Math.min(debtorEquity, (asset[i].exemption + asset[i].wildcardExemption)); // ignore exemptions greater than equity. 

        exemptionTotal += exemptions;
        debtorEquityTotal += debtorEquity; 
        distributionUnsecureds += debtorEquity - exemptions;

        document.getElementById("total-18" + i).innerHTML = cos.toLocaleString("en-US", CURRENCY_FORMAT);
        document.getElementById("total-20" + i).innerHTML = cosSubTotal.toLocaleString("en-US", CURRENCY_FORMAT);
        document.getElementById("total-22" + i).innerHTML = netEquity.toLocaleString("en-US", CURRENCY_FORMAT);
        document.getElementById("total-24" + i).innerHTML = debtorEquity.toLocaleString("en-US", CURRENCY_FORMAT);
        document.getElementById("total-25" + i).innerHTML = exemptions.toLocaleString("en-US", CURRENCY_FORMAT);
        document.getElementById("total-246").innerHTML = debtorEquityTotal.toLocaleString("en-US", CURRENCY_FORMAT);
        document.getElementById("total-256").innerHTML = exemptionTotal.toLocaleString("en-US", CURRENCY_FORMAT);
        document.getElementById("total-266").innerHTML = Math.max(0, distributionUnsecureds).toLocaleString("en-US", CURRENCY_FORMAT);
        
    }
};

// Helper function that calls all calculation functions. 
function calcAll() {
    fairMarketSum();
    debtorFMV();
    liens();
    debtorEquity();
    exemptionsSum();
    chapter7Fees();
    costOfSale();
};
</script>

<!-- Create PDF -->
<script>
function generatePDF() {
    const { jsPDF } = window.jspdf;
    const caseNumber = document.getElementById("input-11").value;
    const fileName = (caseNumber == '' ? 'LiquidationCalc' : 'LiquidationCalc_' + caseNumber + '.pdf');
    const content = document.getElementById("main-content-container");
    const w = content.offsetWidth;
    const h = content.offsetHeight;
    html2canvas(content, {scrollY:-window.scrollY, scale:2}).then(function(canvas){
        const date = new Date();
        const longDate = date.toLocaleDateString('en-US',{year:"numeric", month:"long", day:"numeric"});
        const localTime = date.toLocaleTimeString();
        const img = canvas.toDataURL("image/jpeg", 1);
        const doc = new jsPDF({orientation: "p", unit: "pt", format: [w, h]});
        doc.addImage(img, "JPEG", 20, 20, w-40, h-80);
        doc.text("https://seattlech13.com/liquidation-calculator", 20, h-20).text(longDate + " " + localTime, w-20, h-20,{align: 'right'});
        doc.save(fileName);
        });
}
</script>
